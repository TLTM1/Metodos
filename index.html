<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Métodos Numéricos</title>
    <!-- 1. Math.js para evaluar funciones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.0/math.min.js"></script>
    
    <!-- 2. Tailwind CSS para la interfaz -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. Estilos personalizados para la app -->
    <style>
        /* Tipografía base */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Estilos para las tablas de resultados (como en tu cuaderno) */
        .results-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .results-table th, .results-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .results-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
        }
        .results-table tbody tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        .results-table tbody tr:hover {
            background-color: #f0f5ff;
        }
        
        /* Clases para los signos (+) y (-) */
        .sign-pos { color: #2f855a; font-weight: bold; }
        .sign-neg { color: #c53030; font-weight: bold; }

        /* Estilos para las matrices de LU */
        .matrix-table {
            border: 2px solid #6b7280;
            border-collapse: collapse;
            margin: 0.5rem 1rem;
            background-color: white;
            border-radius: 4px;
        }
        .matrix-table td {
            padding: 0.5rem 0.75rem;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            border-left: 1px dotted #9ca3af;
            border-right: 1px dotted #9ca3af;
        }
        .matrix-table tr:first-child td { border-top: none; }
        .matrix-table tr:last-child td { border-bottom: none; }
        .matrix-table td:first-child { border-left: none; }
        .matrix-table td:last-child { border-right: none; }
        
        /* Símbolos entre matrices */
        .matrix-op {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4b5563;
            margin: 0 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col min-h-screen">
        <!-- Encabezado Principal -->
        <header class="bg-white shadow-md w-full">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold text-blue-600">Calculadora de Métodos Numéricos</h1>
                    <span class="text-sm text-gray-500">Interfaz Web</span>
                </div>
            </div>
        </header>

        <!-- Contenedor Principal (Menú y Paneles) -->
        <div class="flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full mt-4 px-4 sm:px-6 lg:px-8">
            
            <!-- Menú de Navegación Lateral -->
            <nav class="w-full md:w-1/4 lg:w-1/5 py-4 md:pr-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Métodos</h2>
                    <ul class="space-y-2">
                        <li>
                            <button id="btn-biseccion" onclick="showPanel('biseccion')" class="nav-btn w-full text-left">
                                Bisección
                            </button>
                        </li>
                        <li>
                            <button id="btn-regula" onclick="showPanel('regula')" class="nav-btn w-full text-left">
                                Falsa Posición
                            </button>
                        </li>
                        <li>
                            <button id="btn-lu" onclick="showPanel('lu')" class="nav-btn w-full text-left">
                                Factorización LU
                            </button>
                        </li>
                        <li>
                            <button id="btn-flotante" onclick="showPanel('flotante')" class="nav-btn w-full text-left">
                                Punto Flotante
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Área de Contenido Principal (Paneles) -->
            <main class="w-full md:w-3/4 lg:w-4/5 py-4">
                
                <!-- Panel Bisección (Oculto por defecto) -->
                <div id="panel-biseccion" class="panel hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Método de Bisección</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="b-funcion" class="block text-sm font-medium text-gray-700">Función f(x)</label>
                                <input type="text" id="b-funcion" value="x^3 - x - 2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="b-a" class="block text-sm font-medium text-gray-700">Intervalo [a]</label>
                                <input type="number" id="b-a" value="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="b-b" class="block text-sm font-medium text-gray-700">Intervalo [b]</label>
                                <input type="number" id="b-b" value="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="b-tol" class="block text-sm font-medium text-gray-700">Tolerancia</label>
                                <input type="number" id="b-tol" value="0.0001" step="0.0001" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="b-iter" class="block text-sm font-medium text-gray-700">Max. Iteraciones</label>
                                <input type="number" id="b-iter" value="50" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <button onclick="calcularBiseccion()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all">
                            Calcular Bisección
                        </button>
                        <div id="resultado-biseccion" class="mt-6"></div>
                    </div>
                </div>

                <!-- Panel Regula Falsi (Oculto por defecto) -->
                <div id="panel-regula" class="panel hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Método de Falsa Posición (Regula Falsi)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="r-funcion" class="block text-sm font-medium text-gray-700">Función f(x)</label>
                                <input type="text" id="r-funcion" value="x + ln(x)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="r-a" class="block text-sm font-medium text-gray-700">Intervalo [a]</label>
                                <input type="number" id="r-a" value="0.5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="r-b" class="block text-sm font-medium text-gray-700">Intervalo [b]</label>
                                <input type="number" id="r-b" value="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="r-tol" class="block text-sm font-medium text-gray-700">Tolerancia</label>
                                <input type="number" id="r-tol" value="0.0001" step="0.0001" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="r-iter" class="block text-sm font-medium text-gray-700">Max. Iteraciones</label>
                                <input type="number" id="r-iter" value="50" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <button onclick="calcularRegulaFalsi()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all">
                            Calcular Falsa Posición
                        </button>
                        <div id="resultado-regula" class="mt-6"></div>
                    </div>
                </div>

                <!-- Panel LU (Oculto por defecto) -->
                <div id="panel-lu" class="panel hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Factorización LU (con Pivoteo)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="lu-a" class="block text-sm font-medium text-gray-700">Matriz A (filas en nueva línea, valores con espacio)</label>
                                <textarea id="lu-a" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono">3 -7 -2 2
-3 5 1 0
6 -4 0 -5
9 5 -5 12</textarea>
                            </div>
                            <div>
                                <label for="lu-b" class="block text-sm font-medium text-gray-700">Vector b (valores en nueva línea, ej: 2.3 o 23/10)</label>
                                <textarea id="lu-b" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono">23/10
-13/5
97/20
-64/5</textarea>
                            </div>
                        </div>
                        <button onclick="calcularLU()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all">
                            Calcular LU
                        </button>
                        <div id="resultado-lu" class="mt-6 overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Panel Punto Flotante (Oculto por defecto) -->
                <div id="panel-flotante" class="panel hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Codificación Punto Flotante</h2>
                        <p class="text-sm text-gray-600 mb-4">Recrea la codificación de la foto (ej. IEEE 754). Introduce un número y los bits deseados.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="f-num" class="block text-sm font-medium text-gray-700">Número Decimal</label>
                                <input type="text" id="f-num" value="-13457.258" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="f-exp" class="block text-sm font-medium text-gray-700">Bits Exponente (t)</label>
                                <input type="number" id="f-exp" value="7" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="f-mant" class="block text-sm font-medium text-gray-700">Bits Mantisa (s)</label>
                                <input type="number" id="f-mant" value="13" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <button onclick="calcularFlotante()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-all">
                            Calcular Punto Flotante
                        </button>
                        <div id="resultado-flotante" class="mt-6"></div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- ================================================== -->
    <!-- JAVASCRIPT: Todo el cerebro de la aplicación       -->
    <!-- ================================================== -->
    <script>
        // --- Lógica del Menú de Navegación ---
        const panels = ['biseccion', 'regula', 'lu', 'flotante'];
        const activeBtnClass = 'bg-blue-600 text-white shadow-md';
        const inactiveBtnClass = 'bg-gray-100 text-gray-700 hover:bg-gray-200';

        function showPanel(panelId) {
            panels.forEach(id => {
                const panel = document.getElementById(`panel-${id}`);
                const btn = document.getElementById(`btn-${id}`);
                
                // Comprobaciones para evitar errores si un elemento no existe
                if (id === panelId) {
                    if (panel) panel.classList.remove('hidden');
                    if (btn) {
                        btn.classList.remove(...inactiveBtnClass.split(' '));
                        btn.classList.add(...activeBtnClass.split(' '));
                    }
                } else {
                    if (panel) panel.classList.add('hidden');
                    if (btn) {
                        btn.classList.remove(...activeBtnClass.split(' '));
                        btn.classList.add(...inactiveBtnClass.split(' '));
                    }
                }
            });
        }
        
        // --- Inicialización al Cargar la Página ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Aplicar estilos iniciales a los botones
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn) { // Comprobación de seguridad
                    btn.className = `nav-btn w-full text-left px-4 py-2 rounded-md font-medium transition-all ${inactiveBtnClass}`;
                }
            });
            
            // 2. Mostrar el panel por defecto (Bisección)
            showPanel('biseccion');
        });

        // --- Lógica de Ayuda (Resultados y Errores) ---
        function mostrarError(id, mensaje) {
            const resultadoDiv = document.getElementById(id);
            if (resultadoDiv) {
                resultadoDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">${mensaje}</div>`;
            }
        }

        function mostrarResultado(id, htmlContent) {
            const resultadoDiv = document.getElementById(id);
            if (resultadoDiv) {
                resultadoDiv.innerHTML = htmlContent;
            }
        }


        /**
         * 1. CEREBRO PARA BISECCIÓN Y REGULA FALSI
         */
        function calcularMetodoCerrado(metodo) {
            const id_pref = (metodo === 'biseccion') ? 'b' : 'r';
            const resultadoId = `resultado-${(metodo === 'biseccion') ? 'biseccion' : 'regula'}`;

            try {
                const funcStr = document.getElementById(`${id_pref}-funcion`).value;
                let a = parseFloat(document.getElementById(`${id_pref}-a`).value);
                let b = parseFloat(document.getElementById(`${id_pref}-b`).value);
                const tol = parseFloat(document.getElementById(`${id_pref}-tol`).value);
                const maxIter = parseInt(document.getElementById(`${id_pref}-iter`).value);

                // Compilar la función usando math.js
                let node, comp;
                try {
                    node = math.parse(funcStr);
                    comp = node.compile();
                } catch (e) {
                    throw new Error(`Error en la sintaxis de la función: ${e.message}`);
                }

                // Scope para evaluación, permitiendo ln, exp, etc.
                const scope = { e: math.e };
                const evaluar = (x) => comp.evaluate({ ...scope, x: x, ln: math.log, log10: math.log10, exp: math.exp, sin: math.sin, cos: math.cos, tan: math.tan, sqrt: math.sqrt });

                let fa = evaluar(a);
                let fb = evaluar(b);

                if (fa * fb > 0) {
                    throw new Error(`Error (Teorema de Bolzano): f(a) y f(b) tienen el mismo signo. f(${a})=${fa.toFixed(5)}, f(${b})=${fb.toFixed(5)}`);
                }
                
                // Formato para los signos como en las fotos
                const signClass = (val) => val > 0 ? 'sign-pos' : 'sign-neg';
                const signChar = (val) => val > 0 ? '(+)' : '(-)';

                let tablaHtml = `
                    <h3 class="text-xl font-semibold mb-4">Tabla de Iteraciones</h3>
                    <div class="overflow-x-auto">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>n</th>
                                <th>a</th>
                                <th>b</th>
                                <th>xn</th>
                                <th>f(a)</th>
                                <th>f(b)</th>
                                <th>f(xn)</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>`;

                let xn, fxn;
                let error = Infinity;
                let xn_prev = 0;

                for (let n = 1; n <= maxIter; n++) {
                    if (metodo === 'biseccion') {
                        xn = (a + b) / 2.0;
                    } else { // Regula Falsi
                        if (fb - fa === 0) throw new Error("División por cero en Regula Falsi (f(b) - f(a) = 0).");
                        xn = (a * fb - b * fa) / (fb - fa);
                    }

                    fxn = evaluar(xn);
                    error = Math.abs(xn - xn_prev);
                    xn_prev = xn;
                    
                    tablaHtml += `
                        <tr>
                            <td>${n}</td>
                            <td>${a.toFixed(7)}</td>
                            <td>${b.toFixed(7)}</td>
                            <td><b>${xn.toFixed(7)}</b></td>
                            <td class="${signClass(fa)}">${signChar(fa)}</td>
                            <td class="${signClass(fb)}">${signChar(fb)}</td>
                            <td class="${signClass(fxn)}">${signChar(fxn)}</td>
                            <td>${error.toExponential(3)}</td>
                        </tr>`;

                    if (Math.abs(fxn) < tol || (error < tol && n > 1)) {
                        break; // Criterio de parada
                    }

                    // Actualizar intervalo
                    if (fa * fxn < 0) {
                        b = xn;
                        fb = fxn;
                    } else {
                        a = xn;
                        fa = fxn;
                    }
                }
                
                tablaHtml += `</tbody></table></div>`;
                const resultadoFinal = `<div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                            <h4 class="text-lg font-bold text-blue-800">Resultado Final</h4>
                                            <p class="text-xl">Raíz (xn) ≈ <b class="font-mono">${xn.toFixed(8)}</b></p>
                                            <p>f(xn) ≈ ${fxn.toExponential(4)}</p>
                                        </div>`;

                mostrarResultado(resultadoId, tablaHtml + resultadoFinal);

            } catch (e) {
                mostrarError(resultadoId, e.message);
            }
        }

        function calcularBiseccion() {
            calcularMetodoCerrado('biseccion');
        }

        function calcularRegulaFalsi() {
            calcularMetodoCerrado('regula');
        }


        /**
         * 2. CEREBRO PARA FACTORIZACIÓN LU (CON PIVOTEO PARCIAL)
         */
        function calcularLU() {
            const resultadoId = 'resultado-lu';
            try {
                // Parsear Matriz A
                const strA = document.getElementById('lu-a').value.trim().split('\n');
                let A = strA.map(row => row.trim().split(/\s+/).map(Number));
                
                // Parsear Vector b (con soporte para fracciones)
                const strB = document.getElementById('lu-b').value.trim().split('\n');
                let b = strB.map(val => {
                    val = val.trim();
                    if (val.includes('/')) {
                        const parts = val.split('/');
                        if (parts.length === 2) {
                            const num = parseFloat(parts[0]);
                            const den = parseFloat(parts[1]);
                            if (!isNaN(num) && !isNaN(den) && den !== 0) return num / den;
                        }
                    }
                    const numVal = parseFloat(val);
                    if (isNaN(numVal) && val !== "") throw new Error(`Valor inválido en el vector b: "${val}"`);
                    return numVal;
                }).filter(val => !isNaN(val)); 

                const n = A.length;
                
                // Validar dimensiones
                let invalidDim = false;
                if (n === 0 || b.length !== n) invalidDim = true;
                A.forEach(row => { if (row.length !== n) invalidDim = true; });
                if (invalidDim) {
                    throw new Error("Dimensiones de A y b no coinciden o son incorrectas. A debe ser N x N y b debe ser N x 1.");
                }
                
                // --- LÓGICA LU CON PIVOTEO ---
                let L = Array(n).fill(0).map(() => Array(n).fill(0));
                let U = Array(n).fill(0).map(() => Array(n).fill(0));
                let P = Array(n).fill(0).map((_, i) => i); // Vector de permutación

                // Copia de A a U para trabajar
                for (let i = 0; i < n; i++) {
                    U[i] = [...A[i]];
                }

                function swapRows(matrix, i, k) {
                    [matrix[i], matrix[k]] = [matrix[k], matrix[i]];
                }

                for (let k = 0; k < n; k++) {
                    // Pivoteo Parcial: Encontrar fila con max valor en col k
                    let maxVal = 0;
                    let maxIdx = k;
                    for (let i = k; i < n; i++) {
                        if (Math.abs(U[i][k]) > maxVal) {
                            maxVal = Math.abs(U[i][k]);
                            maxIdx = i;
                        }
                    }

                    if (maxVal === 0) throw new Error("Matriz singular. No se puede continuar (pivote es cero).");

                    // Intercambiar filas en U, P, y L (la parte ya calculada)
                    swapRows(U, k, maxIdx);
                    swapRows(P, k, maxIdx);
                    swapRows(L, k, maxIdx); 
                    
                    L[k][k] = 1; // Diagonal de L es 1 (Doolittle)

                    // Calcular L y U para la columna k
                    for (let i = k + 1; i < n; i++) {
                        L[i][k] = U[i][k] / U[k][k];
                        for (let j = k; j < n; j++) {
                            U[i][j] -= L[i][k] * U[k][j];
                        }
                    }
                }
                
                // --- FIN LÓGICA LU ---

                // Aplicar la permutación P al vector b
                let Pb = Array(n).fill(0);
                for(let i=0; i<n; i++) {
                    Pb[i] = b[P[i]];
                }

                // Paso 2: Resolver Ly = Pb (Sustitución hacia adelante)
                let y = Array(n).fill(0);
                for (let i = 0; i < n; i++) {
                    let sum = 0;
                    for (let j = 0; j < i; j++) sum += L[i][j] * y[j];
                    y[i] = Pb[i] - sum;
                }

                // Paso 3: Resolver Ux = y (Sustitución hacia atrás)
                let x = Array(n).fill(0);
                for (let i = n - 1; i >= 0; i--) {
                    let sum = 0;
                    for (let j = i + 1; j < n; j++) sum += U[i][j] * x[j];
                    if (U[i][i] === 0) throw new Error("División por cero en sustitución hacia atrás. Matriz singular.");
                    x[i] = (y[i] - sum) / U[i][i];
                }

                // Generar HTML de salida
                let html = `
                    <h3 class="text-xl font-semibold mb-4">Paso 1: Factorización PA = LU</h3>
                    <p class="mb-4 text-sm text-gray-600">Usando Pivoteo Parcial. (P es la permutación de filas de A)</p>
                    <div class="flex items-center justify-center flex-wrap">
                        ${matrixToHtml(L)} <span class="matrix-op">×</span> ${matrixToHtml(U)}
                    </div>
                    
                    <h3 class="text-xl font-semibold mt-8 mb-4">Paso 2: Resolver Ly = Pb</h3>
                    <div class="flex items-center justify-center flex-wrap">
                        ${matrixToHtml(L)} <span class="matrix-op">×</span> ${matrixToHtml(y, true)}
                        <span class="matrix-op">=</span> ${matrixToHtml(Pb, true)}
                        <span class="matrix-op">→</span> <b class="text-lg">y =</b> ${matrixToHtml(y, true)}
                    </div>
                    
                    <h3 class="text-xl font-semibold mt-8 mb-4">Paso 3: Resolver Ux = y</h3>
                    <div class="flex items-center justify-center flex-wrap">
                        ${matrixToHtml(U)} <span class="matrix-op">×</span> ${matrixToHtml(x, true)}
                        <span class="matrix-op">=</span> ${matrixToHtml(y, true)}
                        <span class="matrix-op">→</span> <b class="text-lg">x =</b> ${matrixToHtml(x, true)}
                    </div>
                `;
                
                mostrarResultado(resultadoId, html);

            } catch (e) {
                mostrarError(resultadoId, e.message);
            }
        }
        
        /**
         * Helper para mostrar matrices (con conversión a fracción)
         */
        function matrixToHtml(matrix, isVector = false) {
            let html = '<table class="matrix-table">';
            if (isVector) {
                const flatMatrix = matrix.flat(); 
                flatMatrix.forEach(val => {
                    html += `<tr><td>${decimalToFraction(val)}</td></tr>`;
                });
            } else {
                matrix.forEach(row => {
                    html += '<tr>';
                    row.forEach(val => {
                        let displayVal = decimalToFraction(val);
                        html += `<td>${displayVal}</td>`;
                    });
                    html += '</tr>';
                });
            }
            html += '</table>';
            return html;
        }

        /**
         * Calcula el Máximo Común Divisor (GCD)
         */
        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            if (b > a) { [a, b] = [b, a]; }
            while (true) {
                if (b === 0) return a;
                a %= b;
                if (a === 0) return b;
                b %= a;
            }
        }

        /**
         * Convierte un número decimal a su fracción más simple.
         */
        function decimalToFraction(value, tolerance = 1e-9) {
            if (isNaN(value) || value === null) return "NaN";
            
            const sign = value < 0 ? "-" : "";
            const num = Math.abs(value);

            if (Math.abs(num - Math.round(num)) < tolerance) {
                return `${sign}${Math.round(num)}`;
            }

            let best_n = 1, best_d = 1, best_err = Infinity;
            const max_d = 10000; // Denominador máximo

            for (let d = 1; d <= max_d; d++) {
                const n = Math.round(num * d);
                if (n === 0) continue;
                
                const err = Math.abs(num - (n / d));

                if (err < tolerance) {
                    const commonDivisor = gcd(n, d);
                    return `${sign}${n / commonDivisor}/${d / commonDivisor}`;
                }

                if (err < best_err) {
                    best_n = n;
                    best_d = d;
                    best_err = err;
                }
            }
            
            const commonDivisor = gcd(best_n, best_d);
            
            // Si la mejor fracción es suficientemente buena
            if (best_err < 0.001) { 
                 return `${sign}${best_n / commonDivisor}/${best_d / commonDivisor}`;
            }

            // Si no, devolver el decimal
            return value.toFixed(5);
        }


        /**
         * 3. CEREBRO PARA PUNTO FLOTANTE
         */
        function calcularFlotante() {
            const resultadoId = 'resultado-flotante';
            try {
                const num = parseFloat(document.getElementById('f-num').value);
                const bits_exp = parseInt(document.getElementById('f-exp').value);
                const bits_mant = parseInt(document.getElementById('f-mant').value);

                if (isNaN(num) || isNaN(bits_exp) || isNaN(bits_mant) || bits_exp <= 0 || bits_mant <= 0) {
                    throw new Error("Valores inválidos. Asegúrate de que todos los campos sean números positivos.");
                }

                // 1. Signo
                const signo = (num < 0 || Object.is(num, -0)) ? 1 : 0;
                const signo_str = (signo === 1) ? "-" : "+";
                const num_abs = Math.abs(num);

                // 2. Partes entera y fraccionaria
                let parte_entera = Math.floor(num_abs);
                let parte_frac = num_abs - parte_entera;

                let bin_entero = parte_entera.toString(2);
                
                let bin_frac = "";
                let temp_frac = parte_frac;
                for (let i = 0; i < bits_mant + 5; i++) { // +5 bits para redondeo
                    temp_frac *= 2;
                    if (temp_frac >= 1) {
                        bin_frac += "1";
                        temp_frac -= 1;
                    } else {
                        bin_frac += "0";
                    }
                    if (temp_frac === 0) break;
                }

                let html = `<div class="space-y-4">
                            <p><b>Número:</b> ${num}</p>
                            <p><b>1. Binario Puro:</b> ${signo_str}${bin_entero}.${bin_frac}...</p>`;

                // 3. Normalización (Forma 1.xxxxx * 2^E)
                let exponente_real = 0;
                let mantisa_raw = "";

                if (num_abs === 0) {
                    exponente_real = -Infinity;
                    mantisa_raw = "0".repeat(bits_mant + 5);
                } else if (parte_entera > 0) {
                    exponente_real = bin_entero.length - 1;
                    mantisa_raw = bin_entero.substring(1) + bin_frac;
                } else { // num es 0.xxxx
                    let first_one = bin_frac.indexOf('1');
                    if (first_one === -1) { // Caso raro, debería ser 0
                        exponente_real = -Infinity;
                        mantisa_raw = "0".repeat(bits_mant + 5);
                    } else {
                        exponente_real = -(first_one + 1);
                        mantisa_raw = bin_frac.substring(first_one + 1);
                    }
                }
                
                html += `<p><b>2. Normalizado:</b> ${signo_str}1.${mantisa_raw.substring(0, 20)}... x 2^(${exponente_real})</p>`;

                // 4. Exponente con Sesgo (Bias)
                const bias = (2**(bits_exp - 1)) - 1;
                let exp_guardado = exponente_real + bias;
                
                // (Manejo de underflow/overflow simple)
                if (num_abs === 0) exp_guardado = 0; // Cero
                else if (exponente_real < 1 - bias) exp_guardado = 0; // Underflow (denormalizado)
                else if (exponente_real > bias) exp_guardado = (2**bits_exp) - 1; // Overflow (Infinito)
                
                let exp_bin = exp_guardado.toString(2).padStart(bits_exp, '0');

                html += `<p><b>3. Exponente Guardado (con bias ${bias}):</b> ${exponente_real} + ${bias} = ${exp_guardado} ➜ <b>${exp_bin}</b></p>`;

                // 5. Mantisa (con truncado simple)
                // (Una implementación completa usaría "round to nearest, ties to even")
                let mantisa_final = mantisa_raw.substring(0, bits_mant).padEnd(bits_mant, '0');
                
                html += `<p><b>4. Mantisa Guardada:</b> ${mantisa_final}</p>`;

                // 6. Resultado Final (Las Cajitas!)
                html += `
                    <h3 class="text-xl font-semibold pt-4">Representación Final (Como en la foto)</h3>
                    <div class="flex flex-wrap text-center font-bold text-lg">
                        <div class="flex flex-col p-2">
                            <span class="text-sm font-medium">Signo (1)</span>
                            <span class="p-4 bg-yellow-200 text-yellow-800 border border-yellow-400 rounded-l-md">${signo}</span>
                        </div>
                        <div class="flex flex-col p-2">
                            <span class="text-sm font-medium">Exponente (${bits_exp})</span>
                            <span class="p-4 bg-green-200 text-green-800 border-t border-b border-green-400">${exp_bin}</span>
                        </div>
                        <div class="flex flex-col p-2">
                            <span class="text-sm font-medium">Mantisa (${bits_mant})</span>
                            <span class="p-4 bg-blue-200 text-blue-800 border border-blue-400 rounded-r-md">${mantisa_final}</span>
                        </div>
                    </div>
                </div>`;
                
                mostrarResultado(resultadoId, html);

            } catch (e) {
                mostrarError(resultadoId, e.message);
            }
        }

    </script>
</body>
</html>